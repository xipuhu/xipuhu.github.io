---
title: 第五章：无网不利
categories: [读书笔记,Linux shell脚本攻略]
tags: [shell]
toc: true
---

### 网络设置

　　联网就是将主机进行互联以形成网络，使得网络中的主机得以交换信息。应用最广泛的网站栈就是TCP/IP，其中每个节点后分配了一个用作标识的独一的IP地址。有很多联网参数，如子网掩码、路由、端口和DNS等。
<!--more-->

　　网络接口用于将主机连接到网络。在Linux中通常使用eth0、eth1（指代以太网接口）这种方式来命名网络接口。还有一些其他的接口，如usb0、wlan0等，分别对应USB网络接口、无线LAN。
　　在这则攻略中会涉及如下命令：ifconfig、route、nslookup和host。其中ifconfig命令用于配置及显示网络接口、子网掩码等详细信息，它通常位于/sbin/ifconfig中。

#### 实战演练

- 手动设置网络接口的IP地址：

  ```shell
   # ifconfig wlan0 192.168.0.80 netmask 255.255.252.0
  ```

- 自动配置网络接口，如果你连接到一个支持自动分配IP的有线网络中，只需要使用下面的命令就可以配置网络接口了：

  ```shell
   # dhclient eth0
  ```

- 显示某个特定的IP地址：

  ```shell
   $ ifconfig iface_name
  ```

- 利用符号名对IP地址进行抽象的技术被称为域名服务（DNS），当我们输入google.com，计算机使用配置好的DNS服务器将域名解析为对应的IP地址。
   分配给当前系统的名字服务器可以通过读取/etc/resolv.conf查看：

  ```shell
   $ cat /etc/resolv.conf
   nameserver 8.8.8.8
  ```

- 通过执行host命令，来列出某个域名所有的IP地址：

  ```shell
   $ host google.com
   google.com has address 64.233.181.105
   google.com has address 64.233.181.99
   google.com has address 64.233.181.147
  ```

- 查询DNS相关的细节信息以及名字解析：

  ```shell
   $ nslookup google.com
   Server: 8.8.8.8
   Address: 8.8.8.8#53
   No-authoritative answer:
   Name: google.com
   Address: 64.233.181.105
  ```

- 一个网络中的设备如果想要同另一个网络中的设备进行通信，就需要借助某个同时连接了两个网络的设备，这个特殊的设备被称为网关，它的作用是在不同的网络中转发分组。
   操作系统维护着一个叫做路由表的表格，它包含了关于分组如何转发以及通过网络中的哪些节点转发的信息：

  ```shell
   $ route
   Kernel IP routing table
   Destination GateWay Genmask Flags Metric Ref UseIface
   192.168.0.0  *   255…
  ```

- 为了检查网络上两台主机之间的连通性，ping命令使用互联网控制消息协议（ICMP）中的echo分组。当向某台主机发送echo分组时，如果分组能够送达且该主机处于活动状态，那么它就会返回一条回应。

  ```shell
   $ ping ADDRESS
  ```

#### 补充内容

- 使用fping，可以同时ping一组IP地址，而且响应速度非常快，fping的选项如下：
   选项-a指定打印出所有活动主机的IP地址；
   选项-u指定打印出所有无法到达的主机；
   选项-g指定从“IP地址/子网掩码”记法或者“IP地址范围”记法中生成一组IP地址。

  ```shell
   $ fping -a 192.160.1/24 -g
   或者
   $ fping -a 192.160.1 192.168.0.255 -g
  ```

### 使用SSH在远程主机上运行命令

　　SSH是Secure Shell的缩写，因为它使用加密通道来传输网络数据。GNU和Linux发布版默认都不包括SSH，需要使用软件包管理安装openssh-server和openssh-client软件包。SSH服务默认运行在端口22之上。

#### 实战演练

- 连接运行SSH服务器的远程主机：

  ```shell
   $ ssh username@remote_host # username是远程主机上的用户；remote_host可以是域名或IP地址
   例如：
   $ ssh xipuhu@@192.168.0.1
  ```

- SSH服务器默认在端口22上运行，但有些SSH服务器并没有使用这个端口，针对这种情况，可以用SSH的-p port_num来指定端口，比如连接运行在端口422之上的SSH服务器：

  ```shell
   $ ssh user@localhost -p 422
  ```

### 用SSH实现无密码自动登录

　　SSH广泛用于脚本自动化，它使得我们可以在远程主机上执行命令并读取输出。但是在自动化脚本中要求用户输入密码就显然不实际了。因此需要将登录过程自动化。SSH包含了一个内建特性，可以用SSH密钥实现自动登录。SSH采用了非对称加密技术，认证密钥包含两部分：一个公钥和一个私钥。我们可以通过ssh-keygen命令创建认证密钥。要想实现自动化认证，公钥必须放置在服务器中（将其加入文件~/.ssh/authorized_keys），与公钥对应的私钥应该放入登录客户机的~/.ssh目录中。

#### 实战演练

设置SSH自动化认证需要两步：

- 创建SSH密钥，这用于登录远程主机；

- 将生成的公钥传给远程主机，并将其加入文件~/.ssh/authorized_keys中。
   输入命令ssh-keygen创建SSH密钥，并制定加密算法类型为RSA：

  ```shell
   $ ssh-keygen -t rsa
   …
  ```

通过ssh-keygen，现在~/.ssh/id_rsa.pub和~/.ssh/id_rsa已经生成了。id_rsa.pub是生成的公钥，id_rsa是生成的私钥。
公钥必须添加到远程服务器~/.ssh/authorized_keys文件中。
要添加一个密钥文件，可以使用：

```shell
$ ssh user@remote_host “cat >> ~/.ssh/authorized_keys” < ~/.ssh/id_rsa.pub
 Password:
```

自动登录就已经设置好了，从现在开始SSH在运行过程中就不会再提示输入密码了。

### 通过网络传输文件

　　计算机联网的主要目的就是资源共享，在资源共享方面，使用最多的是文件共享。有很多种方法可以用来在网络中传输文件，常见的协议有FTP、SFTP、RSYNC和SCP。通过FTP传输文件可以使用lftp命令，通过SSH连接传输文件可以使用sftp，RSYNC使用SSH与rsync命令，scp用过SSH进行传输。

#### 实战演练

- 文件传输协议（File Transfer Protocol，FTP）是一个古老的用于网络主机之间传输文件的文件传输协议，我们可以用lftp命令访问FTP服务器来进行文件传输，它使用端口21。
   要连接FTP服务器传输文件，可以使用：

  ```shell
   $ lftp username@ftphost # 它会提示你输入密码
   用get filename下载文件：
   $ lftp username@ftphost:~> get filename
   用put filename从当前目录上传文件：
   $ lftp usename@ftphost:~> put filename
   用quit退出lftp会话。
  ```

- SFTP（Secure FTP，安全FTP）是一个类似于FTP的文件传输系统，它运行在SSH连接之上并模拟成FTP接口。它不需要远端运行FTP服务器来进行文件传输，但必须安装并运行OpenSSH服务器。
   运行sftp：

  ```shell
   $ sftp user@domainname # 之后同样以get put quit等命令来操作
   有时候SSH在其他端口运行，我们可以在sftp中用-oPort=PORTNO来指定端口号：
   $ sftp -oPort=422 user@xipuhu.org
  ```

- SCP（Secure Copy Program， 安全复制程序）相较于传统的远程复制工具rcp而言，是一项更安全的文件复制技术。文件均通过SSH加密通道进行传输。
   我们可以像下面这样轻松地将文件传输到远程主机：

  ```shell
   $ scp filename user@remotehost:/home/path  # 该命名会提示你输入密码
   其中scp命令的格式是：
   $ scp SOURCE DESTINATION
   下面的命令可以将远程主机中的文件复制到当前目录，并采用给定的文件名：
   $ scp user@remotehost:/home/path/filename filename
   使用scp的-r选项，我们可以在两台网络主机之间对文件夹进行递归复制：
   $ scp -r /home/xipuhu user@remotehost:/home/backups
  ```