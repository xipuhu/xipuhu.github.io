---
title: 第六章：当个好管家
categories: [读书笔记,Linux shell脚本攻略]
tags: [shell]
toc: true
---

### 监视磁盘使用情况

　　df和du是Linux中用于统计磁盘使用情况的两个重要命令。df是disk free的缩写，du是disk usage的缩写。

<!--more-->

#### 实战演练

- 找出某个文件（或多个文件）占用的磁盘空间：

  ```shell
  $ du filename1 filename2
  ```

- 要获得某个目录中所有文件的磁盘使用情况，并在每一行中显示各个文件的磁盘占用详情，可以使用：

  ```shell
   $ du -a DIRECTORY # -a表示递归
  ```

- 命令du默认显示文件占用的总字节数，但是以标准单位KB、MB或GB显示磁盘使用情况更方便人们阅读。要采用这种更友好放入格式进行打印，可以使用选项-h:

  ```shell
   $ du -h filename
  ```

- du的选项-c可以输出作为命令参数的所有文件和目录的磁盘使用情况，它会在输出结果末尾加上一行总计：

  ```shell
   $ du -c filename
  ```

- 有时候我们需要从磁盘使用统计中排除部分文件。可以使用两种方法指定需要排除的文件：
   按照下面的方法指定一个通配符：

  ```shell
   $ du --exclude “*.txt” FILES # 排除所有的.txt文件
   从文件中获取需要排除的文件列表：
   $ du --exclude-from EXCLUDE.txt DIRECTORY  
  ```

- 我们可以用--max-depth指定du应该遍历的目录层次的最大深度。将深度指定为1，可以统计当前目录下的所有文件占用内存的情况。

  ```shell
   $ du --max-depth 1 .
  ```

### 收集与当前登录用户、启动日志及启动故障的信息

　　收集与操作环境、当前登录用户、主机加电时间、启动故障等相关的信息很有用，接下来将介绍一下命令：who、w、users、uptime、last和lastb。

#### 实战演练

- 获取当前登录用户的相关信息：

  ```shell
   $ who
   xipuhu pts/0 2010-09-29 05:24
   xipuhu tty7 2010-09-29 07:08
  ```


   上述命令会显示出登录名、用户所使用的TTY、登录时间以及登录用户的远程主机名。

- 获得有关登录用户更详细的信息可以使用w：

  ```shell
   $ w
  ```

- 列出当前登录主机的用户列表：

  ```shell
   $ users
   xipuhu skynux
  ```

- 查看系统已经加电运行了多长时间：

  ```shell
   $ uptime
   21:44:33 up 3:17, 8 users, load average: 0.09, 0.14, 0.09
  ```

- 获取上一次启动以及用户登录会话的信息：

  ```shell
   $ last
  ```

#### 补充内容

- TTY（该术语取自TeleTYperwriter）是与文本终端相关联的设备文件。当用户生成一个新终端时，对应的设备文件就会出现在/dev/中（例如/dev/pts/3）。可以通过输入并执行命令tty来获得当前终端的设备路径。

### 监视类工具

　　监视类工具的名称流行以top（进程监视命令）作为结尾，依照这种命名习惯，监视磁盘I/O的工具就叫做iotop，测量电源的使用情况的工具叫做powertop，这些工具在多数Linux发布版中都没有被预装，需要我们使用软件包管理器自行安装。

#### 实战演练

- powertop的用法相当简单，只需要运行以下命令即可：

  ```shell
   $ powertop
   以及生成HTML格式的报表：
   $ powertop --html
  ```

- 使用iotop进行I/O监视的方法多种多样，主要有以下几种：
   交互式监视：

  ```shell
   $ iotop -o # -o选项只显示出那些正在进行I/O活动的进程，该选项有助于减少输出干扰
   用于shell脚本的非交互式用法：
   $ iotop -b -n 2 # 这使得iotop打印出两次统计数据
   监视特定进程：
   $ iotop -p PID
  ```

### 收集进程信息

　　进程是程序的运行实例，运行在一台计算机中的多个进程都被分配了一个称为进程ID（PID）的唯一标识数字。同一个程序的多个实例可以同时运行，但是它们的PID却互不相同。进程包括多种属性，例如拥有该进程的用户、进程使用的内存数量、进程占用的CPU时间等。ps是手机进程信息的重要工具。它提供的信息包括：拥有进程的用户、进程的起始时间、进程对应的命令行路径、PID、进程所属的终端（TTY）、进程使用的内存、进程占用的CPU等。ps默认显示的信息中，大多数都没什么用处，我们可以用-o来指定想要显示的列，以便只打印出我们需要的内容：

```shell
$ ps [other options] -o parameter1,parameter2.. # 参数之间以逗号作为定界符诶，且逗号与参数之间是没有空格的。
```

选项-o可以使用不同的参数：

- pcpu  CPU占用率
- pid   进程ID
- ppid  父进程ID
- pmem  内存使用率
- comm  可执行文件名
- cmd   简单命令
- user  启动进程的用户
- nice  优先级
- time  累积的CPU时间
- etime  进程启动后流逝的时间
- tty   所关联的TTY设备
- euid  有效用户ID
- stat  进程状态

#### 实战演练

- 可以用--sort将ps命令的输出根据特定的列进行排序，在参数前面加上+（升序）或-（降序）来指定排序方式：

  ```shell
   $ ps -eo comm,pcpu —sort -pcpu | head # 列出占用CPU最多的10个进程
  ```

- 可以通过ps或pgrep命令来找出给定命令名所对应的进程ID：

  ```shell
   $ ps -C COMMAND_NAME
   或者
   $ pgrep COMMAND
  ```

- 通常与进程线程相关的信息在ps输出中是看不到的。我们可以用选项-L在ps输出中显示线程的相关信息，这会显示出两列：NLWP和NLP，前者表示进程中的线程数量，后者表示线程ID：

  ```shell
   $ ps -eLf
  ```

- 了解某个进程依赖哪些环境变量，这类信息我们通常都用得着，进程的运行方式可能极其依赖某组环境变量。要在ps的输出条目中同时列出环境变量，可以使用：

  ```shell
   $ ps -eo cmd e
   例如：
   $ ps -eo pid,cmd e | tail -n 3
  ```

#### 补充内容

which、whereis、file、whatis：

- which命令用来找出某个命令的位置：

  ```shell
   $ which ls
   /bin/ls
  ```

- whereis与which命令类似，但它不仅返回命令的路径，还能够打印出其对应的命令手册的位置以及命令源代码的路径（如果有的话）：

  ```shell
   $ whereis ls
   ls: /bin/ls /usr/share/man/man1/ls.1.gz
  ```

- whatis命令会输出作为参数的命令的简短描述信息，这些信息是从命令手册中解析得来的：

  ```shell
   $ whatis ls
   ls(1)  	-list directory contents
  ```

- file命令可以用来确定文件的类型：

  ```shell
   $ file FILENAME
  ```

　　在GUN/Linux操作系统中，/proc是一个在内存中的伪文件系统。它的引入是为了提供一个可以从用户空间读取系统参数的接口，我们能够从中获取到大量的信息。通常/proc/PID中会有如下一些重要的文件：

- environ：包含与进程相关的环境变量；
- cwd：是一个到进程工作目录的符号链接；
- exe：是一个到当前工程所对应的可执行文件的符号链接；
- fd：包含了进程所使用的文件描述符。

### 杀死进程以及发送或响应信号

　　在类Unix环境中与进程相关的一个重要概念就是信号，信号是一种进程间通信机制，它用来中断运行中的进程以执行某些操作。终止程序也是通过使用信号技术来实现的。每一种信号都同一个整数值相关联。当进程接收到一个信号时，它会通过执行对应的信号处理程序来进行响应。在shell脚本中同样可以发送、接收并响应信号。kill是用于终止进程的信号。像Ctrl+C、Ctrl+Z这种事件也会发送各自的信号。kill命令可以用来向进程发送信号，而trap命令用来处理所接收的信号。

#### 实战演练

- 列出所有可用的信号：

  ```shell
   $ kill -l # 该命令会打印出信号编号以及对应的信号名称
  ```

- 终止进程：

  ```shell
   $ kill PROCESS_ID_LIST # kill命令默认发出一个TERM信号
  ```

- 要通过kill命令向进程发送指定的信号，可以使用：

  ```shell
   $ kill -s SIGNAL PID # SINGAL要么是信号名称，要么是信号编号
  ```

- 我们经常要强行杀死进程，可以使用：

  ```shell
   $ kill -s SIGKILL PROCESS_ID
   或者
   $ kill -9 PROCESS_ID
  ```

- trap命令在脚本中用来为信号分配信号处理程序，一旦使用trap将某个函数分配给一个信号，那么当脚本运行收到该信号时，其对应的函数就会开始执行，命令语法如下：

  ```shell
   $ trap ‘singal_handler_function_name’ SINGAL LIST
   SINGAL LIST以空格分隔，它可以是信号编号或者信号名称。
  ```

   下面是一个能够响应信号SIGINT的shell脚本：

  ```shell
   #/bin/bash
   #文件名：sighandle.sh
   #用途：信号处理程序
   function handler()
   {
    echo Hey, received signal:SIGINT
   }
   echo My process ID is $$ # $$是一个特殊变量，它可以返回当前进程/脚本的进程ID
   trap ‘handler’ SIGINT
   while true:
   do
    sleep 1
   done
  ```

#### 补充内容

- 尽管很多信号可用于不同的目的，但经常用到的其实只有那么几个，具体如下所示：
   SIGHUP  1————对控制进程或终端的终结进行挂起检测
   SIGINT  2————当按下Ctrl+C时发送该信号
   SIGKILL  9————用于强行杀死进程
   SIGTERM  15————默认用于终止进程
   SIGTSTP  20————当按下Ctrl+Z时发送该信号

### 用cron进行调度

　　我们经常会需要安排脚本在某个时间或每隔一段时间来运行。GUN/Linux系统包含了各种可用于任务调度的工具。cron就是其中之一，它通过守护进程cron使得任务能够按照固定的时间间隔在系统后台运行。要想进程任务调度，我们得知道cron表的格式。一项cron作业指定了需要执行的脚本或命令的路径以及执行时间。cron表中的每一个条目都由6部分组成，并按照下列顺序排序：

- 分钟（0~59）
- 小时（0~23）
- 天（1~31）
- 月份（1~12）
- 工作日（0~6）
- 命令（在指定时间执行的脚本或命令）

　　其中星号（*）指定命令应该在每个时间段执行。也就是说，如果*是写在cron作业中的小时字段中，那么命令就会每小时执行一次。与此类似，如果你希望在某个特定时间段执行命令，那么就在对应的时间字段中指定时段，并用逗号分隔（例如要在5分钟和10分钟时运行命令，那就在分钟字段中输入“5,10”）。还有一种不错的选项，比如在分钟字段使用*/5，可以每5分钟运行一次命令。

#### 实战演练

- 创建一项cron作业，在每天中每小时的第2分钟执行脚本test.sh：

  ```shell
   $ 02 * * * * /home/xipuhu/test.sh
  ```

- 在每天的第5、6、7小时执行脚本：

  ```shell
   $ 00 5,6,7 * * /home/xipuhu/test.sh
  ```

- 在每周日的每12个小时执行脚本：

  ```shell
   $ 00 */12 * * 0 /home/xipuhu/test.sh
  ```

- 在每天凌晨2点关闭计算机：

  ```shell
   $ 00 02 * * * /sbin/sutdown -h
  ```

- 使用选项-e可以来编辑cron表：

  ```shell
   $ crontab -e
   输入crontab -e后，会打开默认的文本编辑器（通常是vi）供用户输入cron作业并保存。
  ```

- 如果我们在脚本中调用crontab进行任务调度，那么有以下方法可供使用：

  ```shell
   创建一个文本文件（例如task.cron），并写入cron作业。将文件名作为命令参数运行crontab：
   $ crontab task.cron
  ```

### 用户管理

　　GUN/Linux是一个多用户操作系统，多个用户可以同时登录并执行多种操作。有一些管理任务会涉及用户管理，这包括为用户设置默认shell、禁用某个用户、禁用某个shell账户、添加新用户、删除用户、设置密码、设置账户有效期等。

#### 实战演练

- useradd命令可以用来创建新用户，命令语法如下：
   useradd USER -p PASSWORD
- 选项-m用来创建home目录，也可以用选项-c FULLNAME 提供用户名的全名。
- deluser命令用来删除用户：
   deluser USER
- --remove-all-files用来删除与用户相关的所有文件，包括home目录。
- chsh命令用来修改用户的默认shell：
   chsh USER -s SHELL
- passwd命令用来更改用户密码：
   passwd USER