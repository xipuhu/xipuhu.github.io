import"./modulepreload-polyfill.c7c6310f.js";import{f as d,c as p,t as B,r as U,a as v,b as y,s as b,l as G,p as V,m as C}from"./vec3.f14a70f7.js";var z=`@group(0) @binding(0) var<storage> modelViews : array<mat4x4<f32>>;
@group(0) @binding(1) var<uniform> projection : mat4x4<f32>;
@group(0) @binding(2) var<storage> colors : array<vec4<f32>>;

struct VertexOutput {
    @builtin(position) Position : vec4<f32>,
    @location(0) fragPosition : vec3<f32>,
    @location(1) fragNormal : vec3<f32>,
    @location(2) fragUV : vec2<f32>,
    @location(3) fragColor : vec4<f32>
}

@vertex
fn main(
    @builtin(instance_index) index : u32,
    @location(0) position : vec3<f32>,
    @location(1) normal : vec3<f32>,
    @location(2) uv : vec2<f32>
) -> VertexOutput {
    let modelView = modelViews[index];
    let mvp = projection * modelView;
    let pos = vec4<f32>(position, 1.0);

    var output : VertexOutput;
    output.Position = mvp * pos;
    output.fragPosition = (modelView * pos).xyz;
    output.fragNormal = (modelView * vec4<f32>(normal, 0.0)).xyz;
    output.fragUV = uv;
    output.fragColor = colors[index];

    return output;
}
`,M=`
@fragment
fn main(
    @location(0) fragPosition : vec3<f32>,
    @location(1) fragNormal : vec3<f32>,
    @location(2) fragUV : vec2<f32>,
    @location(3) fragColor : vec4<f32>
) -> @location(0) vec4<f32> {
    let objectColor = fragColor.rgb;
    return vec4<f32>(objectColor, 1.0);
}`;const g=new Float32Array([0,1,0,0,1,0,.05,1,0,1,0,0,1,0,.15,1,0,1,0,0,1,0,.25,1,0,1,0,0,1,0,.35,1,0,1,0,0,1,0,.45,1,0,1,0,0,1,0,.55,1,0,1,0,0,1,0,.65,1,0,1,0,0,1,0,.75,1,0,1,0,0,1,0,.85,1,0,1,0,0,1,0,.95,1,0,1,0,0,1,0,1.05,1,-.30902,.95106,0,-.30902,.95106,0,0,.9,-.25,.95106,.18164,-.25,.95106,.18164,.1,.9,-.09549,.95106,.29389,-.09549,.95106,.29389,.2,.9,.09549,.95106,.29389,.09549,.95106,.29389,.3,.9,.25,.95106,.18164,.25,.95106,.18164,.4,.9,.30902,.95106,0,.30902,.95106,0,.5,.9,.25,.95106,-.18164,.25,.95106,-.18164,.6,.9,.09549,.95106,-.29389,.09549,.95106,-.29389,.7,.9,-.09549,.95106,-.29389,-.09549,.95106,-.29389,.8,.9,-.25,.95106,-.18164,-.25,.95106,-.18164,.9,.9,-.30902,.95106,0,-.30902,.95106,0,1,.9,-.58779,.80902,0,-.58779,.80902,0,0,.8,-.47553,.80902,.34549,-.47553,.80902,.34549,.1,.8,-.18164,.80902,.55902,-.18164,.80902,.55902,.2,.8,.18164,.80902,.55902,.18164,.80902,.55902,.3,.8,.47553,.80902,.34549,.47553,.80902,.34549,.4,.8,.58779,.80902,0,.58779,.80902,0,.5,.8,.47553,.80902,-.34549,.47553,.80902,-.34549,.6,.8,.18164,.80902,-.55902,.18164,.80902,-.55902,.7,.8,-.18164,.80902,-.55902,-.18164,.80902,-.55902,.8,.8,-.47553,.80902,-.34549,-.47553,.80902,-.34549,.9,.8,-.58779,.80902,0,-.58779,.80902,0,1,.8,-.80902,.58779,0,-.80902,.58779,0,0,.7,-.65451,.58779,.47553,-.65451,.58779,.47553,.1,.7,-.25,.58779,.76942,-.25,.58779,.76942,.2,.7,.25,.58779,.76942,.25,.58779,.76942,.3,.7,.65451,.58779,.47553,.65451,.58779,.47553,.4,.7,.80902,.58779,0,.80902,.58779,0,.5,.7,.65451,.58779,-.47553,.65451,.58779,-.47553,.6,.7,.25,.58779,-.76942,.25,.58779,-.76942,.7,.7,-.25,.58779,-.76942,-.25,.58779,-.76942,.8,.7,-.65451,.58779,-.47553,-.65451,.58779,-.47553,.9,.7,-.80902,.58779,0,-.80902,.58779,0,1,.7,-.95106,.30902,0,-.95106,.30902,0,0,.6,-.76942,.30902,.55902,-.76942,.30902,.55902,.1,.6,-.29389,.30902,.90451,-.29389,.30902,.90451,.2,.6,.29389,.30902,.90451,.29389,.30902,.90451,.3,.6,.76942,.30902,.55902,.76942,.30902,.55902,.4,.6,.95106,.30902,0,.95106,.30902,0,.5,.6,.76942,.30902,-.55902,.76942,.30902,-.55902,.6,.6,.29389,.30902,-.90451,.29389,.30902,-.90451,.7,.6,-.29389,.30902,-.90451,-.29389,.30902,-.90451,.8,.6,-.76942,.30902,-.55902,-.76942,.30902,-.55902,.9,.6,-.95106,.30902,0,-.95106,.30902,0,1,.6,-1,0,0,-1,0,0,0,.5,-.80902,0,.58779,-.80902,0,.58779,.1,.5,-.30902,0,.95106,-.30902,0,.95106,.2,.5,.30902,0,.95106,.30902,0,.95106,.3,.5,.80902,0,.58779,.80902,0,.58779,.4,.5,1,0,0,1,0,0,.5,.5,.80902,0,-.58779,.80902,0,-.58779,.6,.5,.30902,0,-.95106,.30902,0,-.95106,.7,.5,-.30902,0,-.95106,-.30902,0,-.95106,.8,.5,-.80902,0,-.58779,-.80902,0,-.58779,.9,.5,-1,0,0,-1,0,0,1,.5,-.95106,-.30902,0,-.95106,-.30902,0,0,.4,-.76942,-.30902,.55902,-.76942,-.30902,.55902,.1,.4,-.29389,-.30902,.90451,-.29389,-.30902,.90451,.2,.4,.29389,-.30902,.90451,.29389,-.30902,.90451,.3,.4,.76942,-.30902,.55902,.76942,-.30902,.55902,.4,.4,.95106,-.30902,0,.95106,-.30902,0,.5,.4,.76942,-.30902,-.55902,.76942,-.30902,-.55902,.6,.4,.29389,-.30902,-.90451,.29389,-.30902,-.90451,.7,.4,-.29389,-.30902,-.90451,-.29389,-.30902,-.90451,.8,.4,-.76942,-.30902,-.55902,-.76942,-.30902,-.55902,.9,.4,-.95106,-.30902,0,-.95106,-.30902,0,1,.4,-.80902,-.58779,0,-.80902,-.58779,0,0,.3,-.65451,-.58779,.47553,-.65451,-.58779,.47553,.1,.3,-.25,-.58779,.76942,-.25,-.58779,.76942,.2,.3,.25,-.58779,.76942,.25,-.58779,.76942,.3,.3,.65451,-.58779,.47553,.65451,-.58779,.47553,.4,.3,.80902,-.58779,0,.80902,-.58779,0,.5,.3,.65451,-.58779,-.47553,.65451,-.58779,-.47553,.6,.3,.25,-.58779,-.76942,.25,-.58779,-.76942,.7,.3,-.25,-.58779,-.76942,-.25,-.58779,-.76942,.8,.3,-.65451,-.58779,-.47553,-.65451,-.58779,-.47553,.9,.3,-.80902,-.58779,0,-.80902,-.58779,0,1,.3,-.58779,-.80902,0,-.58779,-.80902,0,0,.2,-.47553,-.80902,.34549,-.47553,-.80902,.34549,.1,.2,-.18164,-.80902,.55902,-.18164,-.80902,.55902,.2,.2,.18164,-.80902,.55902,.18164,-.80902,.55902,.3,.2,.47553,-.80902,.34549,.47553,-.80902,.34549,.4,.2,.58779,-.80902,0,.58779,-.80902,0,.5,.2,.47553,-.80902,-.34549,.47553,-.80902,-.34549,.6,.2,.18164,-.80902,-.55902,.18164,-.80902,-.55902,.7,.2,-.18164,-.80902,-.55902,-.18164,-.80902,-.55902,.8,.2,-.47553,-.80902,-.34549,-.47553,-.80902,-.34549,.9,.2,-.58779,-.80902,0,-.58779,-.80902,0,1,.2,-.30902,-.95106,0,-.30902,-.95106,0,0,.1,-.25,-.95106,.18164,-.25,-.95106,.18164,.1,.1,-.09549,-.95106,.29389,-.09549,-.95106,.29389,.2,.1,.09549,-.95106,.29389,.09549,-.95106,.29389,.3,.1,.25,-.95106,.18164,.25,-.95106,.18164,.4,.1,.30902,-.95106,0,.30902,-.95106,0,.5,.1,.25,-.95106,-.18164,.25,-.95106,-.18164,.6,.1,.09549,-.95106,-.29389,.09549,-.95106,-.29389,.7,.1,-.09549,-.95106,-.29389,-.09549,-.95106,-.29389,.8,.1,-.25,-.95106,-.18164,-.25,-.95106,-.18164,.9,.1,-.30902,-.95106,0,-.30902,-.95106,0,1,.1,0,-1,0,0,-1,0,-.05,0,0,-1,0,0,-1,0,.05,0,0,-1,0,0,-1,0,.15,0,0,-1,0,0,-1,0,.25,0,0,-1,0,0,-1,0,.35,0,0,-1,0,0,-1,0,.45,0,0,-1,0,0,-1,0,.55,0,0,-1,0,0,-1,0,.65,0,0,-1,0,0,-1,0,.75,0,0,-1,0,0,-1,0,.85,0,0,-1,0,0,-1,0,.95,0]),x=new Uint16Array([0,11,12,1,12,13,2,13,14,3,14,15,4,15,16,5,16,17,6,17,18,7,18,19,8,19,20,9,20,21,12,11,23,11,22,23,13,12,24,12,23,24,14,13,25,13,24,25,15,14,26,14,25,26,16,15,27,15,26,27,17,16,28,16,27,28,18,17,29,17,28,29,19,18,30,18,29,30,20,19,31,19,30,31,21,20,32,20,31,32,23,22,34,22,33,34,24,23,35,23,34,35,25,24,36,24,35,36,26,25,37,25,36,37,27,26,38,26,37,38,28,27,39,27,38,39,29,28,40,28,39,40,30,29,41,29,40,41,31,30,42,30,41,42,32,31,43,31,42,43,34,33,45,33,44,45,35,34,46,34,45,46,36,35,47,35,46,47,37,36,48,36,47,48,38,37,49,37,48,49,39,38,50,38,49,50,40,39,51,39,50,51,41,40,52,40,51,52,42,41,53,41,52,53,43,42,54,42,53,54,45,44,56,44,55,56,46,45,57,45,56,57,47,46,58,46,57,58,48,47,59,47,58,59,49,48,60,48,59,60,50,49,61,49,60,61,51,50,62,50,61,62,52,51,63,51,62,63,53,52,64,52,63,64,54,53,65,53,64,65,56,55,67,55,66,67,57,56,68,56,67,68,58,57,69,57,68,69,59,58,70,58,69,70,60,59,71,59,70,71,61,60,72,60,71,72,62,61,73,61,72,73,63,62,74,62,73,74,64,63,75,63,74,75,65,64,76,64,75,76,67,66,78,66,77,78,68,67,79,67,78,79,69,68,80,68,79,80,70,69,81,69,80,81,71,70,82,70,81,82,72,71,83,71,82,83,73,72,84,72,83,84,74,73,85,73,84,85,75,74,86,74,85,86,76,75,87,75,86,87,78,77,89,77,88,89,79,78,90,78,89,90,80,79,91,79,90,91,81,80,92,80,91,92,82,81,93,81,92,93,83,82,94,82,93,94,84,83,95,83,94,95,85,84,96,84,95,96,86,85,97,85,96,97,87,86,98,86,97,98,89,88,100,88,99,100,90,89,101,89,100,101,91,90,102,90,101,102,92,91,103,91,102,103,93,92,104,92,103,104,94,93,105,93,104,105,95,94,106,94,105,106,96,95,107,95,106,107,97,96,108,96,107,108,98,97,109,97,108,109,100,99,111,101,100,112,102,101,113,103,102,114,104,103,115,105,104,116,106,105,117,107,106,118,108,107,119,109,108,120]),S=540,m=new Float32Array([.5,.5,.5,1,0,0,0,1,.5,.5,-.5,1,0,0,1,1,.5,-.5,.5,1,0,0,0,0,.5,-.5,-.5,1,0,0,1,0,-.5,.5,-.5,-1,0,0,0,1,-.5,.5,.5,-1,0,0,1,1,-.5,-.5,-.5,-1,0,0,0,0,-.5,-.5,.5,-1,0,0,1,0,-.5,.5,-.5,0,1,0,0,1,.5,.5,-.5,0,1,0,1,1,-.5,.5,.5,0,1,0,0,0,.5,.5,.5,0,1,0,1,0,-.5,-.5,.5,0,-1,0,0,1,.5,-.5,.5,0,-1,0,1,1,-.5,-.5,-.5,0,-1,0,0,0,.5,-.5,-.5,0,-1,0,1,0,-.5,.5,.5,0,0,1,0,1,.5,.5,.5,0,0,1,1,1,-.5,-.5,.5,0,0,1,0,0,.5,-.5,.5,0,0,1,1,0,.5,.5,-.5,0,0,-1,0,1,-.5,.5,-.5,0,0,-1,1,1,.5,-.5,-.5,0,0,-1,0,0,-.5,-.5,-.5,0,0,-1,1,0]),h=new Uint16Array([0,2,1,2,3,1,4,6,5,6,7,5,8,10,9,10,11,9,12,14,13,14,15,13,16,18,17,18,19,17,20,22,21,22,23,21]),T=36;function A(e={x:0,y:0,z:0},r={x:0,y:0,z:0},o={x:1,y:1,z:1}){const t=p();return B(t,t,d(e.x,e.y,e.z)),U(t,t,r.x),v(t,t,r.y),y(t,t,r.z),b(t,t,d(o.x,o.y,o.z)),t}const E=d(0,0,0),R=d(0,1,0);function q(e,r=60/180*Math.PI,o=.1,t=100,f={x:0,y:0,z:0}){const n=p(),a=d(f.x,f.y,f.z);B(n,n,a),G(n,a,E,R);const u=p();return V(u,r,e,o,t),C(u,u,n),u}const c=500;async function D(e){if(!navigator.gpu)throw new Error("Not Support WebGPU");const r=await navigator.gpu.requestAdapter({powerPreference:"high-performance"});if(!r)throw new Error("No Adapter Found");const o=await r.requestDevice(),t=e.getContext("webgpu"),f=navigator.gpu.getPreferredCanvasFormat(),n=window.devicePixelRatio||1,a={width:e.clientWidth*n,height:e.clientHeight*n};return e.width=a.width,e.height=a.height,t.configure({device:o,format:f,alphaMode:"opaque"}),{device:o,context:t,format:f,presentationSize:a}}async function N(e,r){const o={vertex:{module:e.createShaderModule({code:z}),entryPoint:"main",buffers:[{arrayStride:32,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x3"},{shaderLocation:2,offset:24,format:"float32x2"}]}]},fragment:{module:e.createShaderModule({code:M}),entryPoint:"main",targets:[{format:r}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"},layout:"auto"};return await e.createRenderPipelineAsync(o)}async function O(e,r,o){const t={width:o.clientWidth*devicePixelRatio,height:o.clientHeight*devicePixelRatio},f=e.createTexture({size:t,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),n={vertex:e.createBuffer({label:"GPUBuffer store vertex",size:m.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),index:e.createBuffer({label:"GPUBuffer store vertex index",size:h.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST})},a={vertex:e.createBuffer({label:"GPUBuffer store vertex",size:g.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),index:e.createBuffer({label:"GPUBuffer store vertex index",size:x.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST})};e.queue.writeBuffer(n.vertex,0,m),e.queue.writeBuffer(n.index,0,h),e.queue.writeBuffer(a.vertex,0,g),e.queue.writeBuffer(a.index,0,x);const u=e.createBuffer({label:"GPUBuffer sotre n*4x4 matrix",size:4*4*4*c,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),s=e.createBuffer({label:"GPUBuffer sotre 4x4 matrix",size:4*4*4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),i=e.createBuffer({label:"GPUBuffer sotre n*4 color",size:4*4*c,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),l=e.createBindGroup({label:"Uniform Group with matrix",layout:r.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:u}},{binding:1,resource:{buffer:s}},{binding:2,resource:{buffer:i}}]});return{depthTexture:f,boxBuffer:n,sphereBuffer:a,modelViewBuffer:u,projectionBuffer:s,colorBuffer:i,vsGroup:l}}function w(e,r,o,t){const f={colorAttachments:[{view:r.getCurrentTexture().createView(),loadOp:"clear",clearValue:{r:.2,g:.3,b:.3,a:1},storeOp:"store"}],depthStencilAttachment:{view:t.depthTexture.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}},n=new Float32Array(c*4*4),a=new Float32Array(c*4);for(let s=0;s<c;++s){const i={x:Math.random()*40-20,y:Math.random()*40-20,z:-50-Math.random()*50},l={x:Math.random(),y:Math.random(),z:Math.random()},P=A(i,l,{x:1,y:1,z:1});n.set(P,s*4*4),a.set([Math.random(),Math.random(),Math.random(),1],s*4)}e.queue.writeBuffer(t.colorBuffer,0,a),e.queue.writeBuffer(t.modelViewBuffer,0,n);function u(){f.colorAttachments[0].view=r.getCurrentTexture().createView();const s=e.createCommandEncoder(),i=s.beginRenderPass(f);i.setPipeline(o),i.setBindGroup(0,t.vsGroup),i.setVertexBuffer(0,t.boxBuffer.vertex),i.setIndexBuffer(t.boxBuffer.index,"uint16"),i.drawIndexed(T,c/2,0,0,0),i.setVertexBuffer(0,t.sphereBuffer.vertex),i.setIndexBuffer(t.sphereBuffer.index,"uint16"),i.drawIndexed(S,c/2,0,0,c/2),i.end();const l=s.finish();e.queue.submit([l]),requestAnimationFrame(u)}requestAnimationFrame(u)}async function F(){const e=document.querySelector("canvas");if(!e)throw new Error("No Canvas");const{device:r,context:o,format:t,presentationSize:f}=await D(e),n=await N(r,t),a=await O(r,n,e);w(r,o,n,a);function u(){const s=f.width/f.height,i=q(s);r.queue.writeBuffer(a.projectionBuffer,0,i)}u(),window.addEventListener("resize",()=>{e.width=e.clientWidth*devicePixelRatio,e.height=e.clientHeight*devicePixelRatio,o.configure({device:r,format:t,alphaMode:"opaque"}),w(r,o,n,a),u()})}F();
